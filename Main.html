<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TouringBank - 项目详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="css/style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- 新增：Firestore SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-blue-600">TouringBank</a>
                    <span class="ml-4 text-gray-500 text-sm">巡演项目详情</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="apiKeyBtn" class="text-blue-600 hover:text-blue-700 text-sm font-medium"><i
                            class="fas fa-key mr-1"></i>API设置</button>
                    <button class="text-gray-500 hover:text-gray-700"><i class="fas fa-bell"></i></button>

                    <div class="ml-4 flex items-center" id="userSection">
                        <!-- 未登录状态 -->
                        <a href="Login.html" id="loginLink"
                            class="text-gray-500 hover:text-blue-600 text-sm flex items-center transition-colors">
                            <i class="fas fa-user mr-2"></i>登录
                        </a>

                        <!-- 已登录状态 -->
                        <div id="userMenu" class="hidden relative">
                            <button id="userMenuBtn"
                                class="text-gray-700 text-sm flex items-center transition-colors hover:text-blue-600">
                                <i class="fas fa-user-circle mr-2 text-lg"></i>
                                <span id="userEmail"></span>
                                <i class="fas fa-chevron-down ml-2 text-xs"></i>
                            </button>

                            <!-- 下拉菜单 -->
                            <div id="userDropdown"
                                class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-50 border border-gray-100">
                                <a href="Userpage.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-list mr-2"></i>我的清单
                                </a>
                                <hr class="my-2 border-gray-100">
                                <a href="#" id="logoutBtn"
                                    class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-50">
                                    <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-6 mb-6">
                <div class="w-full md:w-auto flex-shrink-0">
                    <div
                        class="w-48 aspect-[3/4] bg-gray-200 rounded-lg overflow-hidden relative mx-auto md:mx-0 shadow-md">
                        <img src="https://placehold.co/400x600?text=Loading..." alt="Project Cover"
                            class="w-full h-full object-cover">
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-4">
                        <h1 id="projectTitle" class="text-3xl font-bold text-gray-900">加载中...</h1>
                        <button id="addToListBtn"
                            class="text-gray-400 hover:text-red-500 transition-colors bg-white p-2 rounded-full shadow-sm border border-gray-100"
                            title="添加到我的清单">
                            <i class="far fa-heart text-2xl"></i>
                        </button>
                    </div>

                    <!-- Overview API Status Bar -->
                    <div id="overviewStatusBar"
                        class="hidden mb-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-100">
                        <div class="flex items-center justify-between gap-4">
                            <div id="status-date"
                                class="flex items-center gap-2 px-3 py-1 bg-white rounded-lg shadow-sm transition-all">
                                <i class="fas fa-circle-notch fa-spin text-gray-300 text-sm"></i>
                                <span class="text-xs text-gray-500">日期确认</span>
                            </div>
                            <div id="status-overview"
                                class="flex items-center gap-2 px-3 py-1 bg-white rounded-lg shadow-sm transition-all flex-1">
                                <i class="fas fa-circle-notch fa-spin text-gray-300 text-sm"></i>
                                <span class="text-xs text-gray-500">概览查询</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">是否在巡演</p>
                            <p id="touringStatus" class="text-lg font-bold text-gray-900">加载中...</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">当前巡演主题</p>
                            <p id="tourTheme" class="text-lg font-bold text-gray-900">加载中...</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg md:col-span-2">
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">巡演规模</p>
                                    <p id="tourScale" class="text-lg font-bold text-gray-900">加载中...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">巡演频次</p>
                                    <p id="tourFrequency" class="text-sm font-medium text-gray-900">加载中...</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">主题跨度</p>
                                    <p id="tourThemeSpan" class="text-sm font-medium text-gray-900">加载中...</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1"><span id="targetRegionName">目标区域</span>未来是否有巡演</p>
                            <p id="regionFutureTours" class="text-lg font-bold text-gray-900">加载中...</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">计划巡演城市</p>
                            <p id="plannedCities" class="text-sm font-medium text-gray-900">加载中...</p>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Detailed API Status Bar -->
            <div id="apiStatusBar"
                class="hidden mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-gray-700">区域数据加载状态</span>
                    <span id="statusSummary" class="text-xs text-gray-500">0/7 完成</span>
                </div>
                <div class="grid grid-cols-7 gap-2">
                    <div id="status-北美"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">北美</span>
                    </div>
                    <div id="status-欧洲"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">欧洲</span>
                    </div>
                    <div id="status-中国大陆"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">中国大陆</span>
                    </div>
                    <div id="status-港台"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">港台</span>
                    </div>
                    <div id="status-日韩"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">日韩</span>
                    </div>
                    <div id="status-东南亚"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">东南亚</span>
                    </div>
                    <div id="status-大洋洲"
                        class="flex flex-col items-center p-2 bg-white rounded-lg shadow-sm transition-all">
                        <i class="fas fa-circle-notch fa-spin text-gray-300 text-lg mb-1"></i>
                        <span class="text-xs text-gray-500">大洋洲</span>
                    </div>
                </div>
            </div>

            <!-- Regional Rankings Section -->
            <div class="mb-6">
                <p class="text-sm font-medium text-gray-700 mb-3">区域排名 & 场馆统计</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Map Visualization -->
                    <div id="ranking-map"
                        class="relative bg-blue-50 rounded-lg w-full aspect-[2/1] overflow-hidden border border-blue-100 md:col-span-2 lg:col-span-1">
                        <!-- World Map Background -->
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg"
                            alt="World Map"
                            class="absolute inset-0 w-full h-full object-contain opacity-40 mix-blend-multiply">

                        <!-- Markers -->
                        <div id="marker-北美"
                            class="hidden absolute top-[33%] left-[28%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('北美')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">北美</span>
                        </div>
                        <div id="marker-欧洲"
                            class="hidden absolute top-[28%] left-[52%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('欧洲')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">欧洲</span>
                        </div>
                        <div id="marker-中国大陆"
                            class="hidden absolute top-[39%] left-[72%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('中国大陆')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">中国大陆</span>
                        </div>
                        <div id="marker-港台"
                            class="hidden absolute top-[48%] left-[75%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('港台')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">港台</span>
                        </div>
                        <div id="marker-日韩"
                            class="hidden absolute top-[34%] left-[79%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('日韩')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">日韩</span>
                        </div>
                        <div id="marker-东南亚"
                            class="hidden absolute top-[60%] left-[73%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('东南亚')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">东南亚</span>
                        </div>
                        <div id="marker-大洋洲"
                            class="hidden absolute top-[75%] left-[79%] flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group cursor-pointer"
                            onclick="updateVenueChart('大洋洲')">
                            <div class="w-3 h-3 bg-blue-600 rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-blue-600 rounded-full relative z-10 border-2 border-white shadow-sm">
                            </div>
                            <span
                                class="marker-count text-[10px] font-bold text-blue-800 mt-1 bg-white/90 px-1.5 py-0.5 rounded shadow-sm backdrop-blur-sm">0</span>
                            <span
                                class="absolute -bottom-6 text-[10px] font-medium text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-1 rounded shadow-sm whitespace-nowrap">大洋洲</span>
                        </div>
                    </div>

                    <!-- Rankings List -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-bold text-gray-700">演出场次排名</h3>
                            <span id="total-concerts"
                                class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <div id="regional-rankings"
                            class="space-y-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">
                            <!-- Populated by JS -->
                            <div class="text-center text-gray-400 text-xs py-4">加载中...</div>
                        </div>
                    </div>

                    <!-- Venue Statistics Chart -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-bold text-gray-700">场馆类型分布</h3>
                            <span id="chart-region-name" class="text-xs font-medium text-gray-500">点击地图区域查看</span>
                        </div>
                        <div id="venue-chart" class="space-y-3">
                            <div class="text-center text-gray-400 text-xs py-8">请选择区域</div>
                        </div>
                    </div>

                    <!-- Average Capacity Ranking -->
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-bold text-gray-700">平均场馆容量排名</h3>
                        </div>
                        <div id="average-capacity-rankings"
                            class="space-y-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">
                            <!-- Populated by JS -->
                            <div class="text-center text-gray-400 text-xs py-4">加载中...</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Tour Trajectory Section -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">巡演轨迹</h2>
                <div id="timeline" class="overflow-x-auto pb-4 mb-4">
                    <div class="text-center text-gray-400 text-sm py-8">正在加载巡演轨迹...</div>
                </div>

                <!-- Detailed Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th onclick="handleSort('date')" class="py-3 px-3 text-xs font-medium text-gray-600">
                                    演出日期<span id="sort-date" class="sort-icon"></span></th>
                                <th onclick="handleSort('weekday')" class="py-3 px-3 text-xs font-medium text-gray-600">
                                    星期<span id="sort-weekday" class="sort-icon"></span></th>
                                <th onclick="handleSort('tourTheme')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    巡演主题<span id="sort-tourTheme" class="sort-icon"></span></th>
                                <th onclick="handleSort('region')" class="py-3 px-3 text-xs font-medium text-gray-600">
                                    地区<span id="sort-region" class="sort-icon"></span></th>
                                <th onclick="handleSort('city')" class="py-3 px-3 text-xs font-medium text-gray-600">
                                    城市<span id="sort-city" class="sort-icon"></span></th>
                                <th onclick="handleSort('venue')" class="py-3 px-3 text-xs font-medium text-gray-600">
                                    场馆<span id="sort-venue" class="sort-icon"></span></th>
                                <th onclick="handleSort('capacity')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    容量<span id="sort-capacity" class="sort-icon"></span></th>
                                <th onclick="handleSort('priceRange')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    票价区间<span id="sort-priceRange" class="sort-icon"></span></th>
                                <th onclick="handleSort('ticketSaleDate')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    开票时间<span id="sort-ticketSaleDate" class="sort-icon"></span></th>
                                <th onclick="handleSort('soldOutDate')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    售罄时间<span id="sort-soldOutDate" class="sort-icon"></span></th>
                                <th onclick="handleSort('saleSpeed')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    售票速度<span id="sort-saleSpeed" class="sort-icon"></span></th>
                                <th onclick="handleSort('organizer')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    主办方<span id="sort-organizer" class="sort-icon"></span></th>
                                <th onclick="handleSort('attendance')"
                                    class="py-3 px-3 text-xs font-medium text-gray-600">
                                    上座率<span id="sort-attendance" class="sort-icon"></span></th>
                                <th onclick="handleSort('status')" class="py-3 px-3 text-xs font-medium text-gray-600">
                                    状态<span id="sort-status" class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50">
                                <td colspan="14" class="py-8 px-4 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="loadMoreContainer" class="text-center mt-4 hidden">
                    <button id="loadMoreBtn"
                        class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors">
                        加载更多 <i class="fas fa-chevron-down ml-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-bold text-gray-900 mb-4">LLM API 配置</h3>
                <p class="text-sm text-gray-600 mb-4">选择 LLM 提供商并输入对应的 API 密钥</p>

                <!-- Provider Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">LLM 提供商</label>
                    <select id="llmProvider"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="gemini">Gemini (Google Search 支持)</option>
                        <option value="openai">OpenAI (GPT-4)</option>
                    </select>
                </div>

                <!-- Gemini API Key -->
                <div id="geminiKeySection" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key</label>
                    <input type="password" id="geminiApiKeyInput" placeholder="输入 Gemini API Key"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- OpenAI API Key -->
                <div id="openaiKeySection" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                    <input type="password" id="openaiApiKeyInput" placeholder="输入 OpenAI API Key"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex justify-between items-center gap-2 mt-4 pt-4 border-t border-gray-200">
                    <button id="clearCacheBtn" class="px-4 py-2 text-red-600 hover:text-red-700 text-sm font-medium">
                        <i class="fas fa-trash-alt mr-1"></i>清除缓存
                    </button>
                    <div class="flex gap-2">
                        <button id="cancelApiKey" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                        <button id="saveApiKey"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingIndicator"
            class="hidden fixed top-20 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg">
            <i class="fas fa-spinner fa-spin mr-2"></i>正在获取数据...
        </div>

        <script src="js/firebase-config.js"></script>
        <script>
            // 用户状态监听
            auth.onAuthStateChanged(function (user) {
                const loginLink = document.getElementById('loginLink');
                const userMenu = document.getElementById('userMenu');
                const userEmail = document.getElementById('userEmail');

                if (user) {
                    // 用户已登录
                    console.log('当前用户:', user);

                    // 隐藏登录链接，显示用户菜单
                    loginLink.classList.add('hidden');
                    userMenu.classList.remove('hidden');

                    // 显示用户邮箱（或显示名）
                    const displayText = user.displayName || user.email.split('@')[0];
                    userEmail.textContent = displayText;

                } else {
                    // 用户未登录
                    console.log('用户未登录');

                    // 显示登录链接，隐藏用户菜单
                    loginLink.classList.remove('hidden');
                    userMenu.classList.add('hidden');
                }
            });

            // 用户菜单下拉功能
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');

            if (userMenuBtn) {
                userMenuBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });

                // 点击其他地方关闭下拉菜单
                document.addEventListener('click', function () {
                    userDropdown.classList.add('hidden');
                });
            }

            // 退出登录
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function (e) {
                    e.preventDefault();

                    try {
                        await auth.signOut();
                        console.log('退出登录成功');
                        alert('已退出登录');
                        // 刷新页面
                        window.location.reload();
                    } catch (error) {
                        console.error('退出登录失败:', error);
                        alert('退出登录失败');
                    }
                });
            }
        </script>

        <script src="js/firebase-config.js"></script>
        <!-- 新增：加载 favorites manager -->
        <script src="js/favorites-manager.js"></script>
        <script src="js/main.js"></script>
</body>

</html>