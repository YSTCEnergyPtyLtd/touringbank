<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>æˆ‘çš„æœºä¼šæ¸…å•</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Noto Sans SC', sans-serif;
        }

        .slide-container {
            width: 100%;
            min-height: 100vh;
            position: relative;
            background-color: #f9fafb;
            display: flex;
        }

        .sidebar {
            width: 240px;
            background-color: #f3f4f6;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
        }

        .main-content {
            margin-left: 240px;
            width: calc(100% - 240px);
            min-height: 100vh;
            overflow-y: auto;
        }

        .folder-item {
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .folder-item:hover {
            background-color: #e5e7eb;
        }

        .folder-item.active {
            background-color: #dbeafe;
            color: #2563eb;
            font-weight: 500;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .kpi-card {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            transition: all 0.2s;
        }

        .kpi-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .project-card {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .project-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
        }

        .badge-green {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .badge-yellow {
            background-color: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .badge-blue {
            background-color: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }

        .status-blue {
            color: #2563eb;
        }

        .status-purple {
            color: #8b5cf6;
        }

        .status-orange {
            color: #f59e0b;
        }

        .status-green {
            color: #10b981;
        }

        .status-gray {
            color: #6b7280;
        }

        .fixed-bottom-bar {
            position: fixed;
            bottom: 0;
            right: 0;
            width: calc(100% - 240px);
            background-color: white;
            border-top: 1px solid #e5e7eb;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <div class="slide-container">
        <!-- å·¦ä¾§è¾¹æ  - æ”¶è—å¤¹ç®¡ç† -->
        <div class="sidebar h-full">
            <div class="px-4 py-5">
                <p class="text-xl font-bold text-gray-800 mb-6">æˆ‘çš„æ¸…å•</p>
                <div class="folder-item active flex justify-between items-center mb-2">
                    <p class="text-sm">å…¨éƒ¨é¡¹ç›®</p>
                    <p class="text-sm bg-blue-100 text-blue-700 px-2 rounded-full">18</p>
                </div>
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mt-4 mb-2 px-2">æˆ‘çš„æ”¶è—å¤¹</p>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ğŸ“ IPéŸ³ä¹ä¼š</p>
                    </div>
                    <p class="text-sm text-gray-600">5</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ğŸ“ æµè¡Œæ¼”å”±ä¼š</p>
                    </div>
                    <p class="text-sm text-gray-600">8</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ğŸ“ å¤å…¸éŸ³ä¹ä¼š</p>
                    </div>
                    <p class="text-sm text-gray-600">3</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ğŸ“ å…¶ä»–</p>
                    </div>
                    <p class="text-sm text-gray-600">2</p>
                </div>
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mt-4 mb-2 px-2">æŒ‰ç›®æ ‡åŒºåŸŸå¸‚åœºåˆ†ç±»</p>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">å¤§æ´‹æ´²é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">7</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">åŒ—ç¾é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">3</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">æ¬§æ´²é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">2</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ä¸­å›½å¤§é™†é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">1</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">æ—¥éŸ©é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">2</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">æ¸¯å°é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">2</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ä¸œå—äºšé¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">2</p>
                </div>
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mt-4 mb-2 px-2">æŒ‰çŠ¶æ€åˆ†ç±»</p>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <span class="status-dot bg-gray-400"></span>
                        <p class="text-sm">æœªè”ç³»</p>
                    </div>
                    <p class="text-sm text-gray-600">6</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <span class="status-dot bg-blue-500"></span>
                        <p class="text-sm">å·²è”ç³»</p>
                    </div>
                    <p class="text-sm text-gray-600">5</p>
                </div>
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mt-4 mb-2 px-2">è‡ªå®šä¹‰æ”¶è—å¤¹</p>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">â­ Q1ä¼˜å…ˆé¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">3</p>
                </div>
                <div class="folder-item flex justify-between items-center mb-1">
                    <div class="flex items-center">
                        <p class="text-sm">ğŸ’° é«˜é¢„ç®—é¡¹ç›®</p>
                    </div>
                    <p class="text-sm text-gray-600">2</p>
                </div>
                <button
                    class="w-full mt-4 flex items-center justify-center py-2 border border-dashed border-gray-300 rounded-md text-gray-500 hover:border-blue-500 hover:text-blue-500 transition-all">
                    <p class="text-sm">+ åˆ›å»ºæ–°æ”¶è—å¤¹</p>
                </button>
            </div>
        </div>
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content pb-16">
            <div class="px-8 py-6 bg-white border-b border-gray-200">
                <p class="text-2xl font-bold text-gray-800">è¯¦æƒ…</p>
            </div>
            <!-- KPIå¡ç‰‡ -->
            <div class="px-8 py-4">
                <div class="grid grid-cols-4 gap-4">
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500 mb-1">æ€»é¡¹ç›®æ•°</p>
                        <div class="flex items-baseline">
                            <p class="text-2xl font-bold text-blue-600">18</p>
                            <p class="text-sm text-gray-500 ml-2">ä¸ªé¡¹ç›®</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500 mb-1">æœ¬å‘¨æ–°å¢</p>
                        <div class="flex items-baseline">
                            <p class="text-2xl font-bold text-green-600">3</p>
                            <p class="text-sm text-green-500 ml-2">â†‘1</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500 mb-1">å¾…è”ç³»é¡¹ç›®</p>
                        <div class="flex items-baseline">
                            <p class="text-2xl font-bold text-gray-700">6</p>
                            <p class="text-sm text-gray-500 ml-2">ä¸ªé¡¹ç›®</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm text-gray-500 mb-1">è¿‘æœŸæé†’</p>
                        <div class="flex items-baseline">
                            <p class="text-2xl font-bold text-orange-500">2</p>
                            <p class="text-sm text-orange-500 ml-2">âš¡</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ç­›é€‰æ  -->
            <div class="px-8 py-4 flex items-center space-x-4 border-b border-gray-200">
                <!-- æœç´¢æ¡† -->
                <div class="flex items-center bg-white rounded-md px-3 py-2 border border-gray-300 w-64">
                    <i class="fas fa-search text-gray-400"></i>
                    <input class="ml-2 bg-transparent border-none focus:outline-none text-sm w-full"
                        placeholder="æœç´¢é¡¹ç›®åç§°æˆ–å…³é”®è¯..." type="text" />
                </div>
                <!-- é¡¹ç›®ç±»å‹ç­›é€‰ -->
                <div class="relative">
                    <select
                        class="pl-3 pr-8 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option>å…¨éƒ¨ç±»å‹</option>
                        <option>IPéŸ³ä¹ä¼š</option>
                        <option>æµè¡Œæ¼”å”±ä¼š</option>
                        <option>å¤å…¸éŸ³ä¹ä¼š</option>
                        <option>å…¶ä»–</option>
                    </select>
                </div>
                <!-- ç›®æ ‡å¸‚åœºç­›é€‰ -->
                <div class="relative">
                    <select
                        class="pl-3 pr-8 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option>å…¨éƒ¨å¸‚åœº</option>
                        <option>æ¾³æ´²</option>
                        <option>æ–°åŠ å¡</option>
                        <option>é©¬æ¥è¥¿äºš</option>
                        <option>ä¸­å›½</option>
                    </select>
                </div>
                <!-- è”ç³»çŠ¶æ€ç­›é€‰ -->
                <div class="relative">
                    <select
                        class="pl-3 pr-8 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option>å…¨éƒ¨çŠ¶æ€</option>
                        <option>æœªè”ç³»</option>
                        <option>å·²è”ç³»</option>
                    </select>
                </div>
                <!-- æ’åºé€‰é¡¹ -->
                <div class="relative ml-auto">
                    <select
                        class="pl-3 pr-8 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option>æœ€è¿‘æ›´æ–°</option>
                        <option>æœºä¼šè¯„åˆ†</option>
                        <option>ä¼˜å…ˆçº§</option>
                        <option>æ·»åŠ æ—¶é—´</option>
                    </select>
                </div>
            </div>
            <!-- é¡¹ç›®å¡ç‰‡åˆ—è¡¨ -->
            <div id="projectListContainer" class="px-8 py-4">
                <!-- é¡¹ç›®åº•éƒ¨æ“ä½œæŒ‰é’® -->
                <div class="flex justify-center space-x-2 mt-4">
                    <button class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded-md text-sm">
                        <p>æŸ¥çœ‹æ›´å¤šé¡¹ç›®</p>
                    </button>
                </div>
                <!-- çŒœä½ å–œæ¬¢ -->
                <div id="recommendationsSection" class="mt-8 pt-8 border-t border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-sparkles text-purple-600 mr-2"></i>
                            <p class="text-xl font-bold text-gray-800">çŒœä½ å–œæ¬¢</p>
                        </div>
                        <button id="refreshRecommendations" class="text-sm text-blue-600 hover:text-blue-700 flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i>
                            <span>åˆ·æ–°æ¨è</span>
                        </button>
                    </div>
                    <div id="recommendationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- æ¨èå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                        <div class="col-span-full text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>æ­£åœ¨åˆ†ææ‚¨çš„æ”¶è—ï¼Œä¸ºæ‚¨æ¨èç›¸ä¼¼è‰ºäºº...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- åº•éƒ¨å›ºå®šæ“ä½œæ  -->
        <div class="fixed-bottom-bar">
            <div class="flex items-center">
                <input class="mr-2" type="checkbox" />
                <p class="text-sm text-gray-600">å·²é€‰æ‹© 0 ä¸ªé¡¹ç›®</p>
            </div>
            <div class="flex items-center space-x-3">
                <button class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded-md text-sm">
                    <p>æ‰¹é‡æ ‡è®°çŠ¶æ€</p>
                </button>
                <button class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded-md text-sm">
                    <p>æ‰¹é‡å¯¼å‡º</p>
                </button>
                <button class="px-3 py-1.5 bg-white border border-gray-300 text-gray-600 rounded-md text-sm">
                    <p>æ‰¹é‡ç§»é™¤</p>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebaseé…ç½®å’Œç®¡ç†æ¨¡å— -->
    <script src="js/firebase-config.js"></script>
    <script src="js/favorites-manager.js"></script>

    <!-- ç”¨æˆ·ç™»å½•çŠ¶æ€ç›‘å¬å’Œæ”¶è—åˆ—è¡¨åŠ è½½ -->
    <script>
        // Gemini APIé…ç½®
        const GEMINI_API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent';
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';

        // ç­‰å¾…ç”¨æˆ·ç™»å½•çŠ¶æ€åˆå§‹åŒ–
        firebase.auth().onAuthStateChanged(async function (user) {
            if (user) {
                console.log('ç”¨æˆ·å·²ç™»å½•:', user.email);
                // ç”¨æˆ·å·²ç™»å½•ï¼ŒåŠ è½½æ”¶è—åˆ—è¡¨
                await loadFavorites();
                // åŠ è½½æ¨è
                await loadRecommendations();
            } else {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡åŠ è½½æ”¶è—åˆ—è¡¨');
            }
        });

        // åˆ·æ–°æ¨èæŒ‰é’®äº‹ä»¶
        document.getElementById('refreshRecommendations')?.addEventListener('click', async () => {
            await loadRecommendations();
        });

        // è®¡ç®—å¹¶æ›´æ–°æ”¶è—å¤¹æ•°å­—
        async function updateFolderCounts() {
            const savedProjects = await favoritesManager.getAllFavorites();
            const totalCount = savedProjects.length;

            // æ›´æ–°"å…¨éƒ¨é¡¹ç›®"æ•°é‡
            const allProjectsItem = document.querySelector('.folder-item.active');
            if (allProjectsItem) {
                const countElement = allProjectsItem.querySelector('p.bg-blue-100, p:last-child');
                if (countElement) {
                    countElement.textContent = totalCount;
                }
            }

            // æŒ‰é¡¹ç›®ç±»å‹åˆ†ç±»ç»Ÿè®¡
            const typeCounts = {
                'IPéŸ³ä¹ä¼š': 0,
                'æµè¡Œæ¼”å”±ä¼š': 0,
                'å¤å…¸éŸ³ä¹ä¼š': 0,
                'å…¶ä»–': 0
            };

            // æŒ‰åŒºåŸŸå¸‚åœºåˆ†ç±»ç»Ÿè®¡
            const regionCounts = {
                'å¤§æ´‹æ´²é¡¹ç›®': 0,
                'åŒ—ç¾é¡¹ç›®': 0,
                'æ¬§æ´²é¡¹ç›®': 0,
                'ä¸­å›½å¤§é™†é¡¹ç›®': 0,
                'æ—¥éŸ©é¡¹ç›®': 0,
                'æ¸¯å°é¡¹ç›®': 0,
                'ä¸œå—äºšé¡¹ç›®': 0
            };

            // æŒ‰çŠ¶æ€åˆ†ç±»ç»Ÿè®¡
            const statusCounts = {
                'æœªè”ç³»': 0,
                'å·²è”ç³»': 0
            };

            // ç»Ÿè®¡å„åˆ†ç±»æ•°é‡
            savedProjects.forEach(project => {
                // é¡¹ç›®ç±»å‹ç»Ÿè®¡ï¼ˆæ ¹æ®é¡¹ç›®åç§°æˆ–typeå­—æ®µæ¨æ–­ï¼‰
                const projectType = project.type || inferProjectType(project.name);
                if (typeCounts.hasOwnProperty(projectType)) {
                    typeCounts[projectType]++;
                } else {
                    typeCounts['å…¶ä»–']++;
                }

                // åŒºåŸŸå¸‚åœºç»Ÿè®¡
                const region = (project.region || '').toLowerCase();
                if (region.includes('æ¾³æ´²') || region.includes('æ¾³å¤§åˆ©äºš') || region.includes('æ–°è¥¿å…°') || region.includes('å¤§æ´‹æ´²') || region.includes('australia') || region.includes('oceania')) {
                    regionCounts['å¤§æ´‹æ´²é¡¹ç›®']++;
                } else if (region.includes('åŒ—ç¾') || region.includes('ç¾å›½') || region.includes('åŠ æ‹¿å¤§') || region.includes('north america') || region.includes('usa') || region.includes('canada')) {
                    regionCounts['åŒ—ç¾é¡¹ç›®']++;
                } else if (region.includes('æ¬§æ´²') || region.includes('europe')) {
                    regionCounts['æ¬§æ´²é¡¹ç›®']++;
                } else if ((region.includes('ä¸­å›½') || region.includes('china')) && !region.includes('æ¸¯å°') && !region.includes('é¦™æ¸¯') && !region.includes('å°æ¹¾')) {
                    regionCounts['ä¸­å›½å¤§é™†é¡¹ç›®']++;
                } else if (region.includes('æ—¥æœ¬') || region.includes('éŸ©å›½') || region.includes('japan') || region.includes('korea')) {
                    regionCounts['æ—¥éŸ©é¡¹ç›®']++;
                } else if (region.includes('é¦™æ¸¯') || region.includes('å°æ¹¾') || region.includes('æ¸¯å°') || region.includes('hong kong') || region.includes('taiwan')) {
                    regionCounts['æ¸¯å°é¡¹ç›®']++;
                } else if (region.includes('æ–°åŠ å¡') || region.includes('é©¬æ¥è¥¿äºš') || region.includes('æ³°å›½') || region.includes('å°å°¼') || region.includes('ä¸œå—äºš') || region.includes('singapore') || region.includes('malaysia') || region.includes('thailand') || region.includes('southeast asia')) {
                    regionCounts['ä¸œå—äºšé¡¹ç›®']++;
                }

                // çŠ¶æ€ç»Ÿè®¡ï¼ˆé»˜è®¤ä¸ºæœªè”ç³»ï¼Œå¦‚æœæœ‰statuså­—æ®µåˆ™ä½¿ç”¨ï¼‰
                const status = project.status || 'æœªè”ç³»';
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                } else {
                    statusCounts['æœªè”ç³»']++;
                }
            });

            // æ›´æ–°é¡¹ç›®ç±»å‹æ•°å­—
            updateFolderItemCount('ğŸ“ IPéŸ³ä¹ä¼š', typeCounts['IPéŸ³ä¹ä¼š']);
            updateFolderItemCount('ğŸ“ æµè¡Œæ¼”å”±ä¼š', typeCounts['æµè¡Œæ¼”å”±ä¼š']);
            updateFolderItemCount('ğŸ“ å¤å…¸éŸ³ä¹ä¼š', typeCounts['å¤å…¸éŸ³ä¹ä¼š']);
            updateFolderItemCount('ğŸ“ å…¶ä»–', typeCounts['å…¶ä»–']);

            // æ›´æ–°åŒºåŸŸå¸‚åœºæ•°å­—
            updateFolderItemCount('å¤§æ´‹æ´²é¡¹ç›®', regionCounts['å¤§æ´‹æ´²é¡¹ç›®']);
            updateFolderItemCount('åŒ—ç¾é¡¹ç›®', regionCounts['åŒ—ç¾é¡¹ç›®']);
            updateFolderItemCount('æ¬§æ´²é¡¹ç›®', regionCounts['æ¬§æ´²é¡¹ç›®']);
            updateFolderItemCount('ä¸­å›½å¤§é™†é¡¹ç›®', regionCounts['ä¸­å›½å¤§é™†é¡¹ç›®']);
            updateFolderItemCount('æ—¥éŸ©é¡¹ç›®', regionCounts['æ—¥éŸ©é¡¹ç›®']);
            updateFolderItemCount('æ¸¯å°é¡¹ç›®', regionCounts['æ¸¯å°é¡¹ç›®']);
            updateFolderItemCount('ä¸œå—äºšé¡¹ç›®', regionCounts['ä¸œå—äºšé¡¹ç›®']);

            // æ›´æ–°çŠ¶æ€æ•°å­—
            updateFolderItemCount('æœªè”ç³»', statusCounts['æœªè”ç³»'], true);
            updateFolderItemCount('å·²è”ç³»', statusCounts['å·²è”ç³»'], true);

            // è‡ªå®šä¹‰æ”¶è—å¤¹ç»Ÿè®¡ï¼ˆåŸºäºé¡¹ç›®å±æ€§ï¼‰
            const customCounts = {
                'Q1ä¼˜å…ˆé¡¹ç›®': savedProjects.filter(p => p.priority === 'Q1' || p.priority === 'high').length,
                'é«˜é¢„ç®—é¡¹ç›®': savedProjects.filter(p => p.budget === 'high' || (p.score && p.score >= 95)).length
            };
            updateFolderItemCount('â­ Q1ä¼˜å…ˆé¡¹ç›®', customCounts['Q1ä¼˜å…ˆé¡¹ç›®']);
            updateFolderItemCount('ğŸ’° é«˜é¢„ç®—é¡¹ç›®', customCounts['é«˜é¢„ç®—é¡¹ç›®']);

            // æ›´æ–°KPIå¡ç‰‡
            updateKPICards(savedProjects);
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®é¡¹ç›®åç§°æ¨æ–­é¡¹ç›®ç±»å‹
        function inferProjectType(projectName) {
            const name = projectName.toLowerCase();
            if (name.includes('ip') || name.includes('çŸ¥è¯†äº§æƒ') || name.includes('åŠ¨æ¼«') || name.includes('æ¸¸æˆ')) {
                return 'IPéŸ³ä¹ä¼š';
            } else if (name.includes('æµè¡Œ') || name.includes('pop') || name.includes('æ¼”å”±ä¼š')) {
                return 'æµè¡Œæ¼”å”±ä¼š';
            } else if (name.includes('å¤å…¸') || name.includes('classical') || name.includes('äº¤å“') || name.includes('ç®¡å¼¦')) {
                return 'å¤å…¸éŸ³ä¹ä¼š';
            }
            return 'å…¶ä»–';
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°æ”¶è—å¤¹é¡¹çš„æ•°å­—
        function updateFolderItemCount(text, count, isStatus = false) {
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                const textElements = item.querySelectorAll('p.text-sm');
                if (textElements.length >= 1) {
                    const firstText = textElements[0].textContent.trim();
                    const searchText = text.replace('ğŸ“ ', '').replace('â­ ', '').replace('ğŸ’° ', '');
                    
                    // å¯¹äºçŠ¶æ€é¡¹ï¼ŒåŒ¹é…æ–‡æœ¬ï¼ˆå¯èƒ½åŒ…å«çŠ¶æ€ç‚¹ï¼‰
                    if (isStatus) {
                        if (firstText.includes(text) || firstText === text) {
                            // æ‰¾åˆ°æœ€åä¸€ä¸ªpå…ƒç´ ï¼ˆåº”è¯¥æ˜¯æ•°å­—ï¼‰
                            if (textElements.length >= 2) {
                                textElements[textElements.length - 1].textContent = count;
                            }
                        }
                    } else {
                        // å¯¹äºæ™®é€šé¡¹ï¼ŒåŒ¹é…æ–‡æœ¬å†…å®¹
                        if (firstText.includes(searchText) || firstText === searchText) {
                            // æ‰¾åˆ°æœ€åä¸€ä¸ªpå…ƒç´ ï¼ˆåº”è¯¥æ˜¯æ•°å­—ï¼‰
                            if (textElements.length >= 2) {
                                const lastElement = textElements[textElements.length - 1];
                                // ç¡®ä¿ä¸æ˜¯åŒ…å«emojiçš„æ–‡æœ¬å…ƒç´ 
                                if (!lastElement.textContent.includes('ğŸ“') && 
                                    !lastElement.textContent.includes('â­') && 
                                    !lastElement.textContent.includes('ğŸ’°')) {
                                    lastElement.textContent = count;
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°KPIå¡ç‰‡
        function updateKPICards(projects) {
            const totalCount = projects.length;
            
            // è®¡ç®—æœ¬å‘¨æ–°å¢ï¼ˆæœ€è¿‘7å¤©ï¼‰
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const thisWeekCount = projects.filter(p => {
                const dateAdded = p.dateAdded ? new Date(p.dateAdded) : null;
                return dateAdded && dateAdded >= oneWeekAgo;
            }).length;

            // å¾…è”ç³»é¡¹ç›®ï¼ˆçŠ¶æ€ä¸ºæœªè”ç³»ï¼‰
            const pendingCount = projects.filter(p => !p.status || p.status === 'æœªè”ç³»').length;

            // è¿‘æœŸæé†’ï¼ˆå¯ä»¥åŸºäºæŸäº›æ¡ä»¶ï¼Œè¿™é‡Œæš‚æ—¶ç”¨å¾…è”ç³»é¡¹ç›®æ•°ï¼‰
            const reminderCount = pendingCount > 0 ? Math.min(pendingCount, 10) : 0;

            // æ›´æ–°KPIå¡ç‰‡
            const kpiCards = document.querySelectorAll('.kpi-card');
            if (kpiCards.length >= 4) {
                // æ€»é¡¹ç›®æ•°
                const totalElement = kpiCards[0].querySelector('.text-2xl');
                if (totalElement) totalElement.textContent = totalCount;

                // æœ¬å‘¨æ–°å¢
                const newElement = kpiCards[1].querySelector('.text-2xl');
                if (newElement) newElement.textContent = thisWeekCount;

                // å¾…è”ç³»é¡¹ç›®
                const pendingElement = kpiCards[2].querySelector('.text-2xl');
                if (pendingElement) pendingElement.textContent = pendingCount;

                // è¿‘æœŸæé†’
                const reminderElement = kpiCards[3].querySelector('.text-2xl');
                if (reminderElement) reminderElement.textContent = reminderCount;
            }
        }

        // åŠ è½½æ”¶è—åˆ—è¡¨å‡½æ•°
        async function loadFavorites() {
            const listContainer = document.getElementById('projectListContainer');

            // ä½¿ç”¨ Firestore manager è·å–æ”¶è—
            const savedProjects = await favoritesManager.getAllFavorites();
            console.log('è·å–åˆ°æ”¶è—é¡¹ç›®:', savedProjects.length);

            // æ›´æ–°æ”¶è—å¤¹æ•°å­—
            await updateFolderCounts();

            if (savedProjects.length > 0 && listContainer) {
                // Generate HTML
                const html = savedProjects.map(p => `
                    <div class="project-card flex bg-blue-50 border-blue-200">
                        <div class="w-20 h-28 bg-gray-200 rounded overflow-hidden flex-shrink-0">
                            <img alt="${p.name}" class="w-full h-full object-cover" src="${p.image || 'https://placehold.co/400x600?text=No+Image'}" />
                        </div>
                        <div class="ml-4 flex-grow">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center">
                                    <p class="font-medium text-lg text-gray-800">${p.name}</p>
                                    <span class="ml-2 px-2 py-0.5 bg-red-100 text-red-800 text-xs rounded-full">æˆ‘çš„æ”¶è—</span>
                                </div>
                                <div class="badge badge-green">
                                    <p>${p.score || 90}åˆ†</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-x-12 gap-y-2 mb-3">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">ç›®æ ‡å¸‚åœº</p>
                                    <div class="flex space-x-2">
                                        <div class="badge badge-blue">
                                            <p>${p.region}</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">æ”¶è—æ—¶é—´</p>
                                    <p class="text-sm text-gray-700">${new Date(p.dateAdded).toLocaleDateString()}</p>
                                </div>
                            </div>
                        </div>
                        <div class="ml-4 w-48 flex-shrink-0 border-l border-gray-100 pl-4">
                            <div class="space-y-2">
                                <div>
                                    <p class="text-xs text-gray-500 mb-0.5">æ“ä½œ</p>
                                    <button onclick="removeProject('${p.name}')" class="text-sm text-red-500 hover:underline">ç§»é™¤æ”¶è—</button>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-0.5">è¯¦æƒ…</p>
                                    <a href="Main.html?project=${encodeURIComponent(p.name)}&region=${encodeURIComponent(p.region)}" class="text-sm text-blue-600 hover:underline">æŸ¥çœ‹è¯¦æƒ…</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // åœ¨"æŸ¥çœ‹æ›´å¤šé¡¹ç›®"æŒ‰é’®å‰æ’å…¥æ”¶è—é¡¹ç›®
                const firstChild = listContainer.firstChild;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                while (tempDiv.lastChild) {
                    listContainer.insertBefore(tempDiv.lastChild, firstChild);
                }
            } else if (listContainer) {
                // å¦‚æœæ²¡æœ‰é¡¹ç›®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'text-center py-12 text-gray-500';
                emptyDiv.innerHTML = '<p class="text-lg mb-2">æš‚æ— æ”¶è—é¡¹ç›®</p><p class="text-sm">å»ä¸»é¡µæ·»åŠ ä¸€äº›é¡¹ç›®åˆ°æ”¶è—å§ï¼</p>';
                listContainer.insertBefore(emptyDiv, listContainer.firstChild);
            }
        }

        // ç§»é™¤æ”¶è—é¡¹ç›®
        async function removeProject(name) {
            if (confirm('ç¡®å®šè¦ç§»é™¤å—ï¼Ÿ')) {
                await favoritesManager.removeFavorite(name);
                window.location.reload();
            }
        }

        // åŠ è½½æ¨èè‰ºäºº
        async function loadRecommendations() {
            const container = document.getElementById('recommendationsContainer');
            if (!container) return;

                // æ£€æŸ¥API Key
            if (!GEMINI_API_KEY) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2 text-yellow-500"></i>
                        <p>è¯·å…ˆé…ç½®Gemini API Key</p>
                        <p class="text-sm mt-2">å‰å¾€ä¸»é¡µè®¾ç½®API Keyåå³å¯ä½¿ç”¨æ¨èåŠŸèƒ½</p>
                    </div>
                `;
                return;
            }

            // è·å–æ”¶è—é¡¹ç›®
            const savedProjects = await favoritesManager.getAllFavorites();
            if (savedProjects.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-heart text-2xl mb-2"></i>
                        <p>æš‚æ— æ”¶è—é¡¹ç›®</p>
                        <p class="text-sm mt-2">æ·»åŠ ä¸€äº›æ”¶è—åï¼Œæˆ‘ä»¬ä¼šä¸ºæ‚¨æ¨èç›¸ä¼¼çš„è‰ºäºº</p>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = `
                <div class="col-span-3 text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>æ­£åœ¨åˆ†ææ‚¨çš„æ”¶è—ï¼Œä¸ºæ‚¨æ¨èç›¸ä¼¼è‰ºäºº...</p>
                </div>
            `;

            try {
                // æ„å»ºæç¤ºè¯
                const projectNames = savedProjects.map(p => p.name).join('ã€');
                const projectRegions = [...new Set(savedProjects.map(p => p.region).filter(Boolean))].join('ã€');
                
                const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„éŸ³ä¹äº§ä¸šåˆ†æå¸ˆã€‚ç”¨æˆ·æ”¶è—äº†ä»¥ä¸‹æ¼”å‡ºé¡¹ç›®ï¼š

${projectNames}

è¿™äº›é¡¹ç›®ä¸»è¦æ¶‰åŠçš„å¸‚åœºåŒºåŸŸï¼š${projectRegions || 'å…¨çƒ'}

è¯·åŸºäºç”¨æˆ·çš„æ”¶è—åå¥½ï¼Œæ¨è3ä¸ªä¸è¿™äº›é¡¹ç›®é£æ ¼ã€ç±»å‹æˆ–ç›®æ ‡å¸‚åœºç›¸ä¼¼çš„è‰ºäºº/æ¼”å‡ºé¡¹ç›®ã€‚

è¦æ±‚ï¼š
1. æ¨è3ä¸ªè‰ºäººæˆ–æ¼”å‡ºé¡¹ç›®
2. æ¯ä¸ªæ¨èéœ€è¦åŒ…å«ï¼šè‰ºäºº/é¡¹ç›®åç§°ã€æ¨èç†ç”±ï¼ˆç®€çŸ­è¯´æ˜ä¸ºä»€ä¹ˆæ¨èï¼Œä¸æ”¶è—é¡¹ç›®çš„ç›¸ä¼¼ä¹‹å¤„ï¼‰
3. æ ¼å¼è¦æ±‚ï¼šè¿”å›JSONæ ¼å¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "recommendations": [
    {
      "name": "è‰ºäºº/é¡¹ç›®åç§°",
      "reason": "æ¨èç†ç”±ï¼Œè¯´æ˜ä¸æ”¶è—é¡¹ç›®çš„ç›¸ä¼¼ä¹‹å¤„"
    },
    ...
  ]
}
4. åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—è¯´æ˜`;

                // è°ƒç”¨Gemini API
                const response = await fetch(`${GEMINI_API_ENDPOINT}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'APIè°ƒç”¨å¤±è´¥');
                }

                // è§£æè¿”å›å†…å®¹
                const text = data.candidates[0].content.parts[0].text;
                let recommendations = [];

                // å°è¯•æå–JSON
                try {
                    // å°è¯•ç›´æ¥è§£æJSON
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const jsonData = JSON.parse(jsonMatch[0]);
                        recommendations = jsonData.recommendations || [];
                    }
                } catch (e) {
                    // å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨è§£æ
                    console.warn('JSONè§£æå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨è§£æ:', e);
                    const lines = text.split('\n');
                    let currentName = '';
                    let currentReason = '';
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.includes('name') || line.includes('åç§°') || line.match(/^\d+\./)) {
                            if (currentName && currentReason) {
                                recommendations.push({ name: currentName, reason: currentReason });
                            }
                            currentName = line.replace(/^\d+\./, '').replace(/name[":\s]*/i, '').replace(/åç§°[ï¼š:\s]*/, '').trim();
                            currentReason = '';
                        } else if (line.includes('reason') || line.includes('ç†ç”±') || line.includes('æ¨è')) {
                            currentReason = line.replace(/reason[":\s]*/i, '').replace(/ç†ç”±[ï¼š:\s]*/, '').replace(/æ¨è[ï¼š:\s]*/, '').trim();
                        } else if (line && !currentReason) {
                            currentReason = line;
                        }
                    }
                    if (currentName && currentReason) {
                        recommendations.push({ name: currentName, reason: currentReason });
                    }
                }

                // ç¡®ä¿è‡³å°‘æœ‰3ä¸ªæ¨è
                if (recommendations.length === 0) {
                    throw new Error('æœªèƒ½è§£ææ¨èç»“æœ');
                }

                // é™åˆ¶ä¸º3ä¸ª
                recommendations = recommendations.slice(0, 3);

                // æ˜¾ç¤ºæ¨è
                displayRecommendations(recommendations, container);

            } catch (error) {
                console.error('è·å–æ¨èå¤±è´¥:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>è·å–æ¨èå¤±è´¥</p>
                        <p class="text-sm mt-2 text-gray-600">${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                        <button onclick="loadRecommendations()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            é‡è¯•
                        </button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ¨èå†…å®¹
        function displayRecommendations(recommendations, container) {
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <p>æš‚æ— æ¨è</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recommendations.map((rec, index) => {
                // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢XSS
                const name = (rec.name || 'æœªçŸ¥è‰ºäºº').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const reason = (rec.reason || 'æ¨èç†ç”±').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                return `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow border border-gray-200">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                            ${index + 1}
                        </div>
                        <div class="ml-4 flex-grow">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${name}</h3>
                            <p class="text-sm text-gray-600 leading-relaxed">${reason}</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <button onclick="searchArtist('${rec.name.replace(/'/g, "\\'")}')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-search mr-2"></i>æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // æœç´¢è‰ºäººï¼ˆè·³è½¬åˆ°ä¸»é¡µæœç´¢ï¼‰
        function searchArtist(artistName) {
            window.location.href = `Main.html?search=${encodeURIComponent(artistName)}`;
        }
    </script>
</body>

</html>